# Full Install

**STOP** This assumes you have completed the [Simple Install](INSTALL-Simple.md).

This adds more functionality and ability to control the ghostbox from a mobile device when out walking around with it. We'll set it up so that the Pi will act as a wireless access point, a web server with a basic web interface.

This is a work in progress, both the documentation and the web interface.

The wireless access point uses IP space _10.42.0.0/24_. The Pi itself will be accessible on IP _10.42.0.1_.

## Remove cron job

Since we will have a web interface to control the ghostbox, we don't need rtl_gb to start on boot anymore. Edit _/etc/crontab_ and remove the line added while following the Simple install. If you prefer, you can add a # to the beginning of the line to comment it out and leave it in there. Changes take effect once you save the /etc/crontab file.

## Create wireless access point

Use the following commands to create a hotspot using the built in wireless interface on the Pi.

   ```
   sudo nmcli con add type wifi ifname wlan0 con-name PiGB autoconnect yes ssid PiGB
   sudo nmcli con modify PiGB 802-11-wireless.mode ap 802-11-wireless.band bg ipv4.method shared
   sudo nmcli con up PiGB
   sudo reboot
   ```

Give the Pi a minute or two to boot, and then on your laptop or mobile device wireless you should see SSID **PiGB**, which is an unsecured wireless network, so it will not prompt for password. If you are connected to the PiGB wireless SSID, you can SSH into the Pi which is using IP _10.42.0.1_.

## Securing the wireless AP

The default config above does not set a wireless password. If you want to add a password to the PiGB SSID, run the following commands (replacing _yourpassword_ with the password you want):

   ```
   sudo nmcli con modify PiGB wifi-sec.key-mgmt wpa-psk
   sudo nmcli con modify PiGB wifi-sec.psk "yourpassword"
   ```

I do highly recommend using a wireless password, but your situation might be different.

## Install Icecast for audio streaming

1) Install ezstream and icecast2

   ```
   sudo apt install -y ezstream icecast2
   ```

   It will pop up a window asking if you want to configure icecast2. Leave it on No and hit enter to get out of that window.

2) Edit _/etc/icecast2/icecast.xml_ with `sudo nano /etc/icecast2/icecast.xml` and towards the top there is an _authentication_ section. Change the source-password, relay-password and admin-password. Keep track of these, you'll need it in the next step. Save and exit the file.

3) Create the /etc/ezstream.xml file with `sudo nano /etc/ezstream.xml` and add the following. Under the server section, CHANGEME should be changed to the password you set as the source-password in icecast.xml.

   ```
   <?xml version="1.0" encoding="UTF-8"?>

   <!--
     This ezstream version 1.x configuration file was generated by
     ezstream-cfgmigrate.

     Source (ezstream version 0.x):
       ezstream.xml
     -->

   <ezstream>

     <servers>
       <server>
         <protocol>http</protocol>
         <hostname>127.0.0.1</hostname>
         <password>CHANGEME</password>
         <tls>none</tls>
       </server>
     </servers>

     <streams>
       <stream>
         <mountpoint>/gb</mountpoint>
         <format>OGG</format>
         <stream_name>PiGB - Raspberry Pi Ghostbox</stream_name>
         <stream_url>http://pigb.local/gb</stream_url>
         <stream_genre>Paranormal</stream_genre>
         <stream_description>PiGB - Raspberry Pi Ghostbox</stream_description>
         <stream_quality>2.0</stream_quality>
         <stream_bitrate>128</stream_bitrate>
         <stream_samplerate>44100</stream_samplerate>
         <stream_channels>1</stream_channels>
       </stream>
     </streams>

     <intakes>
       <intake>
         <type>stdin</type>
         <stream_once>yes</stream_once>
       </intake>
     </intakes>
   </ezstream>
   ```

4) Set icecast2 to start on boot and start it

   ```
   sudo systemctl enable icecast2
   sudo systemctl start icecast2
   ```
   
## Installing the web server

1) Remove apache

   ```
   sudo apt-get remove apache2
   ```

2) Install packages

   ```
   sudo apt install -y lighttpd php-fpm php-mbstring php-mysql php-curl php-gd php-curl php-zip php-xml
   ```

3) Remove default web files

   ```
   sudo rm /var/www/html/*
   ```

4) Enable PHP in Lighttpd

   ```
   sudo lighttpd-enable-mod fastcgi
   sudo lighttpd-enable-mod fastcgi-php
   ```

5) Remove existing lighttpd config file for PHP, create new and add the config below

   ```
   sudo rm /etc/lighttpd/conf-available/15-fastcgi-php.conf
   ```

   ```
   sudo nano /etc/lighttpd/conf-available/15-fastcgi-php.conf
   ```

   Add the following and save the file

   ```
   # -*- depends: fastcgi -*-
   # /usr/share/doc/lighttpd/fastcgi.txt.gz
   # http://redmine.lighttpd.net/projects/lighttpd/wiki/Docs:ConfigurationOptions#mod_fastcgi-fastcgi

   ## Start an FastCGI server for php (needs the php5-cgi package)
   fastcgi.server += ( ".php" =>
           ((
                   "socket" => "/var/run/php/php8.2-fpm.sock",
                   "broken-scriptfilename" => "enable"
           ))
   )
   ```

6) Enable directory listing (for recordings directory)

   ```
   echo 'server.dir-listing = "enable"' | sudo tee --append /etc/lighttpd/lighttpd.conf
   ```
    
7) Restart lighttpd and set it to start on boot

   ```
   sudo systemctl restart lighttpd
   sudo systemctl enable lighttpd
   ```

## Installing the web interface

1) Create needed directories and symlinks

   ```
   sudo mkdir -p /var/www/html/gb/noiseprof
   sudo mkdir /var/www/html/gb/recordings
   sudo chown -R pigb:pigb /var/www/html/gb
   sudo ln -s /var/www/html/gb/noiseprof/ /home/pigb/noiseprof
   sudo ln -s /var/www/html/gb/recordings/ /home/pigb/recordings
   ```

2) Download web files and scripts from github

   ```
   wget --no-check-certificate --content-disposition https://raw.githubusercontent.com/inc0gnitus/PiGB/main/webinterface/index.php -O /var/www/html/gb/index.php
   wget --no-check-certificate --content-disposition https://raw.githubusercontent.com/inc0gnitus/PiGB/main/webinterface/index-ffmpeg.php -O /var/www/html/gb/index-ffmpeg.php
   wget --no-check-certificate --content-disposition https://raw.githubusercontent.com/inc0gnitus/PiGB/main/webinterface/startgb.sh -O /home/pigb/startgb.sh
   wget --no-check-certificate --content-disposition https://raw.githubusercontent.com/inc0gnitus/PiGB/main/webinterface/startgb-ffmpeg.sh -O /home/pigb/startgb-ffmpeg.sh
   ```

3) Make the startgb.sh and startgb-ffmpeg.sh scripts executable

   ```
   chmod a+x startgb.sh
   chmod a+x startgb-ffmpeg.sh
   ```
   
4) Allow www-data (the user lighttpd runs as) sudo access without a password

   ```
   echo 'www-data ALL=(ALL) NOPASSWD: ALL' | sudo tee --append /etc/sudoers.d/010_www-data-nopasswd
   ```

5) Download noise profiles for SoX (optional)

   ```
   wget --no-check-certificate --content-disposition https://raw.githubusercontent.com/inc0gnitus/PiGB/main/noiseprofiles/whitenoise.prof -O /home/pigb/noiseprof/whitenoise.prof
   wget --no-check-certificate --content-disposition https://raw.githubusercontent.com/inc0gnitus/PiGB/main/noiseprofiles/pinknoise.prof -O /home/pigb/noiseprof/pinknoise.prof
   wget --no-check-certificate --content-disposition https://raw.githubusercontent.com/inc0gnitus/PiGB/main/noiseprofiles/brownnoise.prof -O /home/pigb/noiseprof/brownnoise.prof
   ```

6) Download some FFMPEG's arnndn neural network noise filter models

   ```
   cd /home/pigb
   git clone https://github.com/richardpl/arnndn-models.git
   mv arnndn-models/*.rnnn /home/pigb/noiseprof
   rm -rf arnndn-models
   ```
   
7) Reboot with `sudo reboot`

You should be all ready to go. See [Usage](USAGE.md) for some more information.
